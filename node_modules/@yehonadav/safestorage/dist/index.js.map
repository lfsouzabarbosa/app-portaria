{"version":3,"file":"index.js","sources":["../src/storage.ts","../src/persist.ts","../src/ClearData.ts"],"sourcesContent":["import { storageFactory } from \"storage-factory\";\r\nimport { stringify } from '@yehonadav/safestringify'\r\n\r\nexport const getStorageItems = (storage:Storage):Record<string, any> => {\r\n  const result:Record<string, any> = {};\r\n\r\n  for (let i = 0, len = storage.length; i < len; ++i ) {\r\n    try {\r\n      const k = storage.key(i);\r\n\r\n      if (k === null)\r\n        continue;\r\n\r\n      const value = storage.getItem(k);\r\n      result[k] = value ? JSON.parse(value) : value;\r\n    }\r\n    catch (e) {\r\n      console.error({getStorageItemsError: e});\r\n    }\r\n  }\r\n\r\n  return result\r\n}\r\n\r\nexport const setStorageItem = <T=any>(storage:Storage, uuid: string, state: T):void => {storage.setItem(uuid, stringify({state}))};\r\n\r\nexport const getStorageItem = <T=any>(storage:Storage, uuid: string):T => {\r\n  const value = storage.getItem(uuid);\r\n\r\n  if (value === null)\r\n    throw Error(`getStorageItemValueError: storage.getItem('${uuid}') did not return a value`);\r\n\r\n  return JSON.parse(value).state\r\n};\r\n\r\nexport const tryToGetStorageItem = <T=any>(storage:Storage, uuid: string):{value?: T, error?: Error} => {\r\n  try {\r\n    return {value: getStorageItem<T>(storage, uuid)};\r\n  }\r\n  catch (error) {\r\n    return {error}\r\n  }\r\n};\r\n\r\nexport const delStorageItem = (storage:Storage, uuid: string):void => {\r\n  // eslint-disable-next-line no-empty\r\n  try{storage.removeItem(uuid)}catch(e){}\r\n};\r\n\r\nexport class StorageHandler {\r\n  storage: Storage;\r\n  clear: () => void;\r\n  private _debug: boolean;\r\n  private readonly _setItem: (key:string, value:any) => void;\r\n  private readonly _clear: () => void;\r\n  private readonly _removeItem: (key:string) => void;\r\n\r\n  constructor(getStorage: () => Storage) {\r\n    this.storage = storageFactory(getStorage);\r\n    this.clear = this.storage.clear;\r\n\r\n    this._debug = false;\r\n    this._setItem = this.storage.setItem;\r\n    this._clear = this.storage.clear;\r\n    this._removeItem = this.storage.removeItem;\r\n  }\r\n\r\n  setDebug(debug:boolean) {\r\n    this._debug = debug;\r\n\r\n    if (debug) {\r\n      this.storage.setItem = (key, value) => {\r\n        console.log({\"storage.setItem\": {key, value}});\r\n        this._setItem(key, value);\r\n      };\r\n\r\n      this.storage.clear = () => {\r\n        console.log(\"storage.clear\");\r\n        this._clear();\r\n      };\r\n\r\n      this.storage.removeItem = (key) => {\r\n        console.log({\"storage.removeItem\": {key}});\r\n        this._removeItem(key);\r\n      };\r\n    }\r\n\r\n    else {\r\n      if (debug) {\r\n        this.storage.setItem = this._setItem;\r\n        this.storage.clear = this._clear;\r\n        this.storage.removeItem = this._removeItem;\r\n      }\r\n    }\r\n  }\r\n\r\n  getDebug() {\r\n    return this._debug;\r\n  }\r\n\r\n  getItems <T=Record<string, any>>():T {\r\n    return getStorageItems(this.storage) as T;\r\n  }\r\n\r\n  setItem (uuid: string, state: any):void {\r\n    setStorageItem(this.storage, uuid, state);\r\n  }\r\n\r\n  getItem <T=any>(uuid: string):T {\r\n    return getStorageItem<T>(this.storage, uuid)\r\n  }\r\n\r\n  tryToGetItem <T=any>(uuid: string):{value?: T, error?: Error} {\r\n    return tryToGetStorageItem<T>(this.storage, uuid);\r\n  }\r\n\r\n  delItem (uuid: string):void {\r\n    delStorageItem(this.storage, uuid)\r\n  }\r\n}\r\n\r\nexport const persistLocal = new StorageHandler(() => localStorage);\r\nexport const persistSession = new StorageHandler(() => sessionStorage);\r\n\r\nexport const local = persistLocal.storage;\r\nexport const session = persistSession.storage;\r\n","import {local, session} from \"./storage\"\r\n\r\nexport const getStorageCall = () => local;\r\nexport const getSessionCall = () => session;\r\n","import {local, session, getStorageItems} from './storage';\r\n\r\nexport type ExcludedItemsType = {[x:string]:any};\r\n\r\nexport const excludedLocalStorageItemKeys:string[] = [];\r\n\r\nexport const excludeLocalStorageItem = (key:string):void => {\r\n  excludedLocalStorageItemKeys.push(key);\r\n};\r\n\r\nexport const getExcludedLocalStorageItems = ():ExcludedItemsType => {\r\n  const items:ExcludedItemsType = {};\r\n  excludedLocalStorageItemKeys.forEach(key => {\r\n    try {\r\n      const item = local.getItem(key);\r\n      if (typeof item === \"string\")\r\n        items[key] = item;\r\n    }\r\n    catch (e) {\r\n      console.error(`getExcludeLocalStorageItems failed to get ${key}`, e)\r\n    }\r\n  });\r\n  return items;\r\n};\r\n\r\nexport const setExcludedLocalStorageItemsAfterClear = (items:ExcludedItemsType):void => {\r\n  Object.keys(items).forEach(key => {\r\n    local.setItem(key, items[key]);\r\n  });\r\n};\r\n\r\nexport const clearCachedData = async ():Promise<void> => {\r\n  const excludedLocalStorageItems = getExcludedLocalStorageItems();\r\n\r\n  console.log({\r\n    clearCachedData: {\r\n      getExcludedLocalStorageItems: {\r\n        type: 'info',\r\n        message: \"get excluded items before clearing data\",\r\n        data: excludedLocalStorageItems,\r\n      }\r\n    }\r\n  });\r\n\r\n  session.clear();\r\n\r\n  local.clear();\r\n\r\n  console.log({\r\n    clearCachedData: {\r\n      type: 'info',\r\n      message: \"cleared session & local storage\",\r\n      data: {\r\n        session: getStorageItems(session),\r\n        local: getStorageItems(local),\r\n      },\r\n    }\r\n  });\r\n\r\n  // early re-set excluded items before clearing data finish, to handle sudden abruption\r\n  setExcludedLocalStorageItemsAfterClear(excludedLocalStorageItems);\r\n\r\n  // https://github.com/shadowwalker/next-pwa/issues/50\r\n  // logout from PWA - not sure this is needed if revoke works\r\n  if ('serviceWorker' in navigator) {\r\n    try {\r\n      const cacheNames = await caches.keys();\r\n      cacheNames.forEach(function(cacheName) {\r\n        caches.delete(cacheName);\r\n      });\r\n\r\n      console.log({\r\n        clearCachedData: {\r\n          type: 'info',\r\n          message: \"cleared caches\",\r\n        }\r\n      });\r\n    }\r\n    catch (e) {\r\n      console.error({\r\n        clearCachedData: {\r\n          type: 'info',\r\n          message: `clearCachedData failed to delete cacheNames: ${e}`,\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  console.log({\r\n    clearCachedData: {\r\n      type: 'info',\r\n      message: \"all cached data has been removed\",\r\n    }\r\n  });\r\n\r\n  // re-set excluded items after clearing data\r\n  setExcludedLocalStorageItemsAfterClear(excludedLocalStorageItems);\r\n\r\n  console.log({\r\n    clearCachedData: {\r\n      setExcludedLocalStorageItemsAfterClear: {\r\n        type: 'info',\r\n        message: \"re-set excluded items after clearing data success\",\r\n        data: excludedLocalStorageItems,\r\n      }\r\n    }\r\n  });\r\n};\r\n\r\nexport const clearDataService = {\r\n  excludeLocalStorageItem,\r\n  clearCachedData,\r\n};"],"names":["stringify","storageFactory"],"mappings":"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"}